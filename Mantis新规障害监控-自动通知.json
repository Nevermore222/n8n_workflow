{
  "name": "Mantisæ–°è§„éšœå®³ç›‘æ§-è‡ªåŠ¨é€šçŸ¥",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 30
            }
          ]
        }
      },
      "id": "schedule-trigger-node",
      "name": "å®šæ—¶è§¦å‘_æ¯30åˆ†é’Ÿ",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [-2560, 240],
      "notes": "æ¯30åˆ†é’Ÿè‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡æ–°æå‡ºçš„éšœå®³"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT COALESCE(MAX(bug_id), 0) AS max_checked_bug_id FROM mantis.new_bug_monitor_log;",
        "options": {}
      },
      "id": "query-max-checked-id-node",
      "name": "æŸ¥è¯¢å·²æ£€æŸ¥çš„æœ€å¤§BugID",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.1,
      "position": [-2336, 240],
      "credentials": {
        "postgres": {
          "id": "tWcUIJhVg6bDlGDc",
          "name": "TargetDB"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "ä»ç›‘æ§æ—¥å¿—è¡¨è·å–ä¸Šæ¬¡æ£€æŸ¥åˆ°çš„æœ€å¤§bug_id"
    },
    {
      "parameters": {
        "jsCode": "// å‡†å¤‡æŸ¥è¯¢å‚æ•°\nconst maxCheckedId = $('æŸ¥è¯¢å·²æ£€æŸ¥çš„æœ€å¤§BugID').first().json.max_checked_bug_id || 0;\n\nreturn [{\n  json: {\n    max_checked_bug_id: maxCheckedId,\n    check_time: new Date().toISOString()\n  }\n}];"
      },
      "id": "prepare-params-node",
      "name": "å‡†å¤‡æŸ¥è¯¢å‚æ•°",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-2112, 240],
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  b.id AS bug_id,\n  p.name AS project_name,\n  FROM_UNIXTIME(b.date_submitted) AS registered_at,\n  CASE b.status\n    WHEN 10 THEN 'new'\n    WHEN 20 THEN 'feedback'\n    WHEN 30 THEN 'acknowledged'\n    WHEN 40 THEN 'confirmed'\n    WHEN 50 THEN 'assigned'\n    WHEN 77 THEN 'èª¿æŸ»ä¸­'\n    WHEN 78 THEN 'ä¿®æ­£ä¸­'\n    WHEN 80 THEN 'resolved'\n    WHEN 85 THEN 'ç¢ºèªæ¸ˆ'\n    WHEN 90 THEN 'closed'\n    ELSE CAST(b.status AS CHAR)\n  END AS status_name,\n  b.summary,\n  bt.description AS detail_description,\n  c.name AS category_name\nFROM mantis_bug_table b\nLEFT JOIN mantis_project_table p ON p.id = b.project_id\nLEFT JOIN mantis_bug_text_table bt ON bt.id = b.bug_text_id\nLEFT JOIN mantis_category_table c ON c.id = b.category_id\nWHERE b.status = 10\n  AND b.id > {{ $json.max_checked_bug_id || 0 }}\n  AND FROM_UNIXTIME(b.date_submitted) >= '2025-10-01 00:00:00'\nORDER BY b.id\nLIMIT 50;",
        "options": {}
      },
      "id": "query-new-bugs-node",
      "name": "æŸ¥è¯¢æ–°è§„éšœå®³",
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.1,
      "position": [-1888, 240],
      "credentials": {
        "mySql": {
          "id": "JN4ZRi7Xi3HQr9k7",
          "name": "SourceDB"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "æŸ¥è¯¢status=10çš„æ–°éšœå®³(2025å¹´10æœˆå)ï¼Œæ¯æ¬¡æœ€å¤š50æ¡"
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $items(\"æŸ¥è¯¢æ–°è§„éšœå®³\").length }}",
              "operation": "larger"
            }
          ]
        }
      },
      "id": "check-has-new-bugs-node",
      "name": "åˆ¤æ–­æ˜¯å¦æœ‰æ–°éšœå®³",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [-1664, 240]
    },
    {
      "parameters": {
        "jsCode": "// æ ¼å¼åŒ–æ–°éšœå®³æ•°æ®ä¸ºå¯è¯»æ–‡æœ¬\nconst bugs = $input.all();\nconst checkTime = $('å‡†å¤‡æŸ¥è¯¢å‚æ•°').first().json.check_time;\n\nif (bugs.length === 0) {\n  return [{ json: { message: 'æ²¡æœ‰æ–°çš„éšœå®³', count: 0 } }];\n}\n\n// ç”Ÿæˆæ±‡æ€»æ–‡æœ¬\nconst lines = [\n  `ğŸ“¢ *æ–°è§„éšœå®³é€šçŸ¥* - ${new Date(checkTime).toLocaleString('ja-JP')}`,\n  ``,\n  `å‘ç° *${bugs.length}* ä¸ªæ–°æå‡ºçš„éšœå®³ (status=10, 2025å¹´10æœˆå)`,\n  ``,\n  `---`,\n  ``\n];\n\n// é€æ¡åˆ—å‡ºéšœå®³ä¿¡æ¯\nbugs.forEach((item, index) => {\n  const bug = item.json;\n  const registeredDate = bug.registered_at ? new Date(bug.registered_at).toLocaleString('ja-JP') : 'N/A';\n  \n  lines.push(`*${index + 1}. Bug #${bug.bug_id}*`);\n  lines.push(`  ğŸ“‹ æ¦‚è¦: ${bug.summary || 'N/A'}`);\n  lines.push(`  ğŸ“ é¡¹ç›®: ${bug.project_name || 'N/A'}`);\n  lines.push(`  ğŸ“‚ åˆ†ç±»: ${bug.category_name || 'N/A'}`);\n  lines.push(`  ğŸ• ç™»å½•æ—¥æœŸ: ${registeredDate}`);\n  lines.push(`  ğŸ“ çŠ¶æ€: ${bug.status_name || 'N/A'}`);\n  \n  if (bug.detail_description) {\n    const desc = bug.detail_description.length > 100 \n      ? bug.detail_description.substring(0, 100) + '...' \n      : bug.detail_description;\n    lines.push(`  ğŸ“„ è¯¦ç»†: ${desc}`);\n  }\n  \n  lines.push(``);\n});\n\nlines.push(`---`);\nlines.push(`æœ€å¤§BugID: ${Math.max(...bugs.map(b => b.json.bug_id))}`);\n\nconst formattedMessage = lines.join('\\n');\n\n// è¿”å›æ ¼å¼åŒ–åçš„æ¶ˆæ¯å’Œè¯¦ç»†æ•°æ®\nreturn [{\n  json: {\n    message: formattedMessage,\n    count: bugs.length,\n    max_bug_id: Math.max(...bugs.map(b => b.json.bug_id)),\n    bugs: bugs.map(b => b.json),\n    check_time: checkTime\n  }\n}];"
      },
      "id": "format-message-node",
      "name": "æ ¼å¼åŒ–é€šçŸ¥æ¶ˆæ¯",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-1440, 128],
      "onError": "continueErrorOutput",
      "notes": "å°†æ–°éšœå®³æ•°æ®æ ¼å¼åŒ–ä¸ºMarkdownæ ¼å¼çš„é€šçŸ¥æ¶ˆæ¯"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO mantis.new_bug_monitor_log (bug_id, check_time, bug_summary, project_name, category_name, registered_at)\nVALUES \n{{ $('æŸ¥è¯¢æ–°è§„éšœå®³').all().map(item => \n  `(${item.json.bug_id}, NOW(), $n8n$${item.json.summary || ''}$n8n$, $n8n$${item.json.project_name || ''}$n8n$, $n8n$${item.json.category_name || ''}$n8n$, $n8n$${item.json.registered_at || ''}$n8n$)`\n).join(',\\n') }}\nON CONFLICT (bug_id) DO UPDATE SET\n  check_time = EXCLUDED.check_time;",
        "options": {}
      },
      "id": "log-checked-bugs-node",
      "name": "è®°å½•å·²æ£€æŸ¥çš„éšœå®³",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.1,
      "position": [-1216, 128],
      "credentials": {
        "postgres": {
          "id": "tWcUIJhVg6bDlGDc",
          "name": "TargetDB"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "å°†æ£€æŸ¥è¿‡çš„éšœå®³è®°å½•åˆ°æ—¥å¿—è¡¨ï¼Œé¿å…é‡å¤é€šçŸ¥"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "CREATE TABLE IF NOT EXISTS mantis.new_bug_monitor_log (\n  id BIGSERIAL PRIMARY KEY,\n  bug_id INTEGER NOT NULL UNIQUE,\n  check_time TIMESTAMP NOT NULL DEFAULT NOW(),\n  bug_summary TEXT,\n  project_name VARCHAR(255),\n  category_name VARCHAR(255),\n  registered_at TIMESTAMP,\n  created_at TIMESTAMP DEFAULT NOW()\n);\n\nCREATE INDEX IF NOT EXISTS idx_new_bug_monitor_bug_id ON mantis.new_bug_monitor_log(bug_id);\nCREATE INDEX IF NOT EXISTS idx_new_bug_monitor_check_time ON mantis.new_bug_monitor_log(check_time);\nCREATE INDEX IF NOT EXISTS idx_new_bug_monitor_registered_at ON mantis.new_bug_monitor_log(registered_at);",
        "options": {}
      },
      "id": "init-monitor-table-node",
      "name": "åˆå§‹åŒ–ç›‘æ§è¡¨",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.1,
      "position": [-2560, 128],
      "credentials": {
        "postgres": {
          "id": "tWcUIJhVg6bDlGDc",
          "name": "TargetDB"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "é¦–æ¬¡è¿è¡Œæ—¶åˆ›å»ºç›‘æ§æ—¥å¿—è¡¨ï¼ˆä»…æ‰§è¡Œä¸€æ¬¡å³å¯ï¼‰"
    }
  ],
  "connections": {
    "å®šæ—¶è§¦å‘_æ¯30åˆ†é’Ÿ": {
      "main": [[{ "node": "æŸ¥è¯¢å·²æ£€æŸ¥çš„æœ€å¤§BugID", "type": "main", "index": 0 }]]
    },
    "æŸ¥è¯¢å·²æ£€æŸ¥çš„æœ€å¤§BugID": {
      "main": [[{ "node": "å‡†å¤‡æŸ¥è¯¢å‚æ•°", "type": "main", "index": 0 }]]
    },
    "å‡†å¤‡æŸ¥è¯¢å‚æ•°": {
      "main": [[{ "node": "æŸ¥è¯¢æ–°è§„éšœå®³", "type": "main", "index": 0 }]]
    },
    "æŸ¥è¯¢æ–°è§„éšœå®³": {
      "main": [[{ "node": "åˆ¤æ–­æ˜¯å¦æœ‰æ–°éšœå®³", "type": "main", "index": 0 }]]
    },
    "åˆ¤æ–­æ˜¯å¦æœ‰æ–°éšœå®³": {
      "main": [
        [{ "node": "æ ¼å¼åŒ–é€šçŸ¥æ¶ˆæ¯", "type": "main", "index": 0 }],
        []
      ]
    },
    "æ ¼å¼åŒ–é€šçŸ¥æ¶ˆæ¯": {
      "main": [[{ "node": "è®°å½•å·²æ£€æŸ¥çš„éšœå®³", "type": "main", "index": 0 }]]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "name": "Mantisç›‘æ§",
      "id": "mantis-monitor-tag"
    }
  ]
}

