{
  "name": "Mantiséšœå®³æ•°æ®-å®æ—¶éšœå®³åŒæ­¥-æ•°æ®æ¸…æ´—-çŸ¥è¯†åº“åµŒå…¥-V2.2.0-æ­£å¼ç‰ˆ",
  "nodes": [
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT COALESCE(MAX(last_synced_bug_id), 0) AS max_synced_bug_id FROM mantis.sync_log WHERE sync_status = 'SUCCESS' AND sync_type = 'INCREMENTAL';",
        "options": {}
      },
      "id": "bbbf3539-2ec8-4c8f-91b2-74d3c30df5d5",
      "name": "æŸ¥è¯¢å·²åŒæ­¥çš„æœ€å¤§BugID",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.1,
      "position": [
        -2640,
        672
      ],
      "credentials": {
        "postgres": {
          "id": "tWcUIJhVg6bDlGDc",
          "name": "TargetDB"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "ä»sync_logè¡¨è·å–ä¸Šæ¬¡æˆåŠŸåŒæ­¥çš„æœ€å¤§bug_idï¼Œé¿å…æ•°æ®é—æ¼"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO mantis.sync_log (sync_type, sync_status, start_time) VALUES ('INCREMENTAL', 'RUNNING', NOW()) RETURNING id as sync_log_id;",
        "options": {}
      },
      "id": "553371be-49c0-4a2e-a3ed-4badb09aa011",
      "name": "åˆ›å»ºåŒæ­¥æ—¥å¿—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.1,
      "position": [
        -2464,
        656
      ],
      "credentials": {
        "postgres": {
          "id": "tWcUIJhVg6bDlGDc",
          "name": "TargetDB"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "// å‡†å¤‡æŸ¥è¯¢å‚æ•°ï¼šä»æœ€å¤§bug_id+1å¼€å§‹åŒæ­¥\nconst maxBugId = $('æŸ¥è¯¢å·²åŒæ­¥çš„æœ€å¤§BugID').first().json.max_synced_bug_id || 0;\nconst syncLogId = $('åˆ›å»ºåŒæ­¥æ—¥å¿—').first().json.sync_log_id;\n\nreturn [{\n  json: {\n    max_synced_bug_id: maxBugId,\n    sync_log_id: syncLogId,\n    offset: 0\n  }\n}];"
      },
      "id": "0d8dcb64-7937-4c82-af4d-47cc167e62a6",
      "name": "å‡†å¤‡æŸ¥è¯¢å‚æ•°",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2288,
        640
      ],
      "onError": "continueErrorOutput",
      "notes": "ä»æœ€å¤§bug_idå¼€å§‹æŸ¥è¯¢ï¼ŒåªåŒæ­¥æ–°å¢æ•°æ®"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH target_bugs AS (\n  SELECT id, {{ $json.offset || 0 }} AS query_offset\n  FROM mantis_bug_table\n  WHERE status = 85\n    AND id > {{ $json.max_synced_bug_id || 0 }}\n  ORDER BY id\n  LIMIT 500 OFFSET {{ $json.offset || 0 }}\n),\nlatest_history AS (\n  SELECT\n    bug_id,\n    field_name,\n    new_value,\n    ROW_NUMBER() OVER (PARTITION BY bug_id, field_name ORDER BY date_modified DESC, id DESC) AS rn\n  FROM mantis_bug_history_table\n  WHERE bug_id IN (SELECT id FROM target_bugs)\n    AND field_name IN (\n      'ç¢ºèªè€…(ãƒ†ã‚¹ãƒˆ)', 'ç¢ºèªæ—¥(ãƒ†ã‚¹ãƒˆ)',\n      'èª¿æŸ»è€…', 'èª¿æŸ»æ—¥',\n      'ä¿®æ­£è€…', 'ä¿®æ­£æ—¥',\n      'ãƒã‚°åˆ†é¡', 'ãƒã‚°åŒºåˆ†', 'é–¢é€£ã‚³ãƒãƒ³ãƒ‰',\n      'åŸå› åŒºåˆ†(å¤§)', 'åŸå› åŒºåˆ†(å°)',\n      'éšœå®³ç™ºç”ŸåŸå› ', 'ä¿®æ­£å†…å®¹'\n    )\n),\nhistory_pivot AS (\n  SELECT\n    bug_id,\n    MAX(CASE WHEN field_name = 'ç¢ºèªè€…(ãƒ†ã‚¹ãƒˆ)' THEN new_value END) AS test_confirmer_name,\n    MAX(CASE WHEN field_name = 'ç¢ºèªæ—¥(ãƒ†ã‚¹ãƒˆ)' THEN new_value END) AS test_confirmed_ts,\n    MAX(CASE WHEN field_name = 'èª¿æŸ»è€…' THEN new_value END) AS investigator,\n    MAX(CASE WHEN field_name = 'èª¿æŸ»æ—¥' THEN new_value END) AS investigated_ts,\n    MAX(CASE WHEN field_name = 'ä¿®æ­£è€…' THEN new_value END) AS fixer,\n    MAX(CASE WHEN field_name = 'ä¿®æ­£æ—¥' THEN new_value END) AS fixed_ts,\n    MAX(CASE WHEN field_name = 'ãƒã‚°åˆ†é¡' THEN new_value END) AS bug_category_jp,\n    MAX(CASE WHEN field_name = 'ãƒã‚°åŒºåˆ†' THEN new_value END) AS bug_classification,\n    MAX(CASE WHEN field_name = 'é–¢é€£ã‚³ãƒãƒ³ãƒ‰' THEN new_value END) AS related_command,\n    MAX(CASE WHEN field_name = 'åŸå› åŒºåˆ†(å¤§)' THEN new_value END) AS cause_large,\n    MAX(CASE WHEN field_name = 'åŸå› åŒºåˆ†(å°)' THEN new_value END) AS cause_small,\n    MAX(CASE WHEN field_name = 'éšœå®³ç™ºç”ŸåŸå› ' THEN new_value END) AS root_cause_text,\n    MAX(CASE WHEN field_name = 'ä¿®æ­£å†…å®¹' THEN new_value END) AS fix_detail_text\n  FROM latest_history\n  WHERE rn = 1\n  GROUP BY bug_id\n)\nSELECT\n  b.id AS bug_id,\n  LPAD(CAST(b.id AS CHAR), 7, '0') AS bug_no_for_ui,\n  p.name AS project_name,\n  CASE b.view_state\n    WHEN 10 THEN 'å…¬é–‹'\n    WHEN 50 THEN 'éå…¬é–‹'\n    ELSE CONCAT('view_state_', b.view_state)\n  END AS view_state_name,\n  FROM_UNIXTIME(b.date_submitted) AS registered_at,\n  FROM_UNIXTIME(b.last_updated) AS last_updated_at,\n  CONCAT_WS('_', hu.username, hu.realname) AS handler_display,\n  CONCAT_WS('_', ru.username, ru.realname) AS reporter_display,\n  CASE b.status\n    WHEN 10 THEN 'new' WHEN 20 THEN 'feedback' WHEN 30 THEN 'acknowledged' WHEN 40 THEN 'confirmed'\n    WHEN 50 THEN 'assigned' WHEN 77 THEN 'èª¿æŸ»ä¸­' WHEN 78 THEN 'ä¿®æ­£ä¸­' WHEN 80 THEN 'resolved'\n    WHEN 85 THEN 'ç¢ºèªæ¸ˆ' WHEN 90 THEN 'closed' ELSE CAST(b.status AS CHAR)\n  END AS status_name,\n  CASE b.priority\n    WHEN 10 THEN 'none' WHEN 20 THEN 'low' WHEN 30 THEN 'normal' WHEN 40 THEN 'high'\n    WHEN 50 THEN 'urgent' WHEN 60 THEN 'immediate' ELSE CAST(b.priority AS CHAR)\n  END AS priority_name,\n  CASE b.severity\n    WHEN 10 THEN 'feature' WHEN 20 THEN 'trivial' WHEN 30 THEN 'text' WHEN 40 THEN 'tweak'\n    WHEN 50 THEN 'minor' WHEN 60 THEN 'major' WHEN 70 THEN 'crash' WHEN 80 THEN 'block'\n    ELSE CAST(b.severity AS CHAR)\n  END AS severity_name,\n  b.reproducibility,\n  b.summary,\n  bt.description AS detail_description,\n  c.name AS category_name,\n  hp.investigator,\n  FROM_UNIXTIME(CAST(hp.investigated_ts AS UNSIGNED)) AS investigated_at,\n  hp.fixer,\n  FROM_UNIXTIME(CAST(hp.fixed_ts AS UNSIGNED)) AS fixed_at,\n  NULLIF(TRIM(hp.bug_category_jp), '') AS bug_category_jp,\n  NULLIF(TRIM(hp.bug_classification), '') AS bug_classification,\n  NULLIF(TRIM(hp.related_command), '') AS related_command,\n  NULLIF(TRIM(hp.cause_large), '') AS cause_large,\n  NULLIF(TRIM(hp.cause_small), '') AS cause_small,\n  hp.root_cause_text,\n  hp.fix_detail_text,\n  tb.query_offset AS current_offset\nFROM target_bugs tb\nJOIN mantis_bug_table b ON b.id = tb.id\nLEFT JOIN mantis_project_table p ON p.id = b.project_id\nLEFT JOIN mantis_user_table hu ON hu.id = b.handler_id\nLEFT JOIN mantis_user_table ru ON ru.id = b.reporter_id\nLEFT JOIN mantis_bug_text_table bt ON bt.id = b.bug_text_id\nLEFT JOIN mantis_category_table c ON c.id = b.category_id\nLEFT JOIN history_pivot hp ON hp.bug_id = b.id\nORDER BY b.id;",
        "options": {}
      },
      "id": "aa41b34b-1150-4a27-993a-fa580d889277",
      "name": "æŸ¥è¯¢å¾…åŒæ­¥æ•°æ®",
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.1,
      "position": [
        -2032,
        608
      ],
      "credentials": {
        "mySql": {
          "id": "JN4ZRi7Xi3HQr9k7",
          "name": "SourceDB"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "æ¯æ‰¹æŸ¥è¯¢500æ¡ï¼Œåç»­é€æ¡æ’å…¥é¿å…å‚æ•°é™åˆ¶"
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $items(\"æŸ¥è¯¢å¾…åŒæ­¥æ•°æ®\").length }}",
              "operation": "larger"
            }
          ]
        }
      },
      "id": "d45c6bfa-28d1-49ba-a21a-7ca459e249db",
      "name": "åˆ¤æ–­æ˜¯å¦æœ‰æ•°æ®",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -1840,
        544
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $items('æŸ¥è¯¢å¾…åŒæ­¥æ•°æ®').length > 0 ? 'SELECT bug_id FROM mantis.bug_analysis WHERE bug_id = ANY(ARRAY[' + $items('æŸ¥è¯¢å¾…åŒæ­¥æ•°æ®').map(item => item.json.bug_id).join(',') + ']::INTEGER[]);' : 'SELECT 0 AS bug_id WHERE FALSE;' }}",
        "options": {}
      },
      "id": "b864822d-17fd-4f0f-94be-94c18950f0a1",
      "name": "æŸ¥è¯¢å·²å­˜åœ¨çš„BugIDåˆ—è¡¨",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.1,
      "position": [
        -1600,
        480
      ],
      "credentials": {
        "postgres": {
          "id": "tWcUIJhVg6bDlGDc",
          "name": "TargetDB"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "æŸ¥è¯¢ç›®æ ‡è¡¨ä¸­å·²å­˜åœ¨çš„bug_idï¼Œç”¨äºè¿‡æ»¤"
    },
    {
      "parameters": {
        "jsCode": "// è¿‡æ»¤æ‰å·²å­˜åœ¨çš„bug_idï¼Œåªä¿ç•™æ–°æ•°æ®\nconst sourceItems = $items(\"æŸ¥è¯¢å¾…åŒæ­¥æ•°æ®\");\nconst existingBugIds = new Set(\n  $items(\"æŸ¥è¯¢å·²å­˜åœ¨çš„BugIDåˆ—è¡¨\").map(item => item.json.bug_id)\n);\n\n// è¿‡æ»¤å‡ºä¸å­˜åœ¨çš„bug_id\nconst newItems = sourceItems.filter(item => {\n  const bugId = item.json.bug_id;\n  return !existingBugIds.has(bugId);\n});\n\nconst newCount = newItems.length;\nconst totalCount = sourceItems.length;\nconst skippedCount = totalCount - newCount;\n\nconsole.log(`æ€»æ•°æ®: ${totalCount}, å·²å­˜åœ¨(è·³è¿‡): ${skippedCount}, æ–°æ•°æ®: ${newCount}`);\n\n// å§‹ç»ˆè¿”å›æ•°æ®ï¼Œä½†æ ‡è®°æ˜¯å¦æœ‰æ–°æ•°æ®\nif (newCount === 0) {\n  // æ²¡æœ‰æ–°æ•°æ®æ—¶ï¼Œè¿”å›ä¸€ä¸ªæ ‡è®°å¯¹è±¡ç”¨äºç»§ç»­æµç¨‹\n  return [{\n    json: {\n      has_new_data: false,\n      skipped_count: skippedCount,\n      message: 'æ‰€æœ‰æ•°æ®å·²å­˜åœ¨ï¼Œè·³è¿‡æ’å…¥'\n    }\n  }];\n}\n\n// æœ‰æ–°æ•°æ®æ—¶ï¼Œä¸ºæ¯ä¸ªitemæ·»åŠ æ ‡è®°\nreturn newItems.map(item => ({\n  json: {\n    ...item.json,\n    has_new_data: true\n  }\n}));"
      },
      "id": "7ee7ce9d-ece9-43dc-ae05-5153c5a3b016",
      "name": "è¿‡æ»¤æ–°æ•°æ®",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1360,
        464
      ],
      "onError": "continueErrorOutput",
      "notes": "è¿‡æ»¤æ‰å·²å­˜åœ¨çš„bug_idï¼Œåªæ’å…¥æ–°æ•°æ®ï¼Œé¿å…å”¯ä¸€é”®å†²çª"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.has_new_data }}",
              "value2": true
            }
          ]
        }
      },
      "id": "1eaa7bbd-63d3-4517-95c2-f85ae0404123",
      "name": "åˆ¤æ–­æ˜¯å¦æœ‰æ–°æ•°æ®è¦æ’å…¥",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -1104,
        384
      ],
      "notes": "å¦‚æœæ²¡æœ‰æ–°æ•°æ®ï¼Œè·³è¿‡æ’å…¥ï¼Œç›´æ¥åˆ¤æ–­æ˜¯å¦ç»§ç»­ä¸‹ä¸€æ‰¹"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "value": "mantis",
          "mode": "list",
          "cachedResultName": "mantis"
        },
        "table": {
          "__rl": true,
          "value": "bug_analysis",
          "mode": "list",
          "cachedResultName": "bug_analysis"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "bug_id": "={{ $json.bug_id }}",
            "bug_no_for_ui": "={{ $json.bug_no_for_ui }}",
            "project_name": "={{ $json.project_name }}",
            "view_state_name": "={{ $json.view_state_name }}",
            "registered_at": "={{ $json.registered_at }}",
            "last_updated_at": "={{ $json.last_updated_at }}",
            "handler_display": "={{ $json.handler_display }}",
            "reporter_display": "={{ $json.reporter_display }}",
            "status_name": "={{ $json.status_name }}",
            "priority_name": "={{ $json.priority_name }}",
            "severity_name": "={{ $json.severity_name }}",
            "reproducibility": "={{ $json.reproducibility }}",
            "summary": "={{ $json.summary }}",
            "detail_description": "={{ $json.detail_description }}",
            "category_name": "={{ $json.category_name }}",
            "investigator": "={{ $json.investigator }}",
            "investigated_at": "={{ $json.investigated_at }}",
            "fixer": "={{ $json.fixer }}",
            "fixed_at": "={{ $json.fixed_at }}",
            "bug_category_jp": "={{ $json.bug_category_jp }}",
            "bug_classification": "={{ $json.bug_classification }}",
            "related_command": "={{ $json.related_command }}",
            "cause_large": "={{ $json.cause_large }}",
            "cause_small": "={{ $json.cause_small }}",
            "root_cause_text": "={{ $json.root_cause_text }}",
            "fix_detail_text": "={{ $json.fix_detail_text }}"
          },
          "matchingColumns": [
            "bug_id"
          ],
          "schema": []
        },
        "options": {
          "queryBatching": "transaction"
        }
      },
      "id": "7981b2cf-6bed-4eea-9196-caba2faa045e",
      "name": "é€æ¡æ’å…¥PostgreSQL",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -896,
        352
      ],
      "credentials": {
        "postgres": {
          "id": "tWcUIJhVg6bDlGDc",
          "name": "TargetDB"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "ä½¿ç”¨åŸç”ŸINSERTèŠ‚ç‚¹é€æ¡æ’å…¥ï¼Œé€šè¿‡matchingColumns=['bug_id']å®ç°UPSERTï¼Œé¿å…ä¸»é”®å†²çª"
    },
    {
      "parameters": {
        "jsCode": "// å‡†å¤‡JSONæ•°æ®ç”¨äºçŸ¥è¯†åº“é¢„å¤„ç†\nconst insertedItems = $('é€æ¡æ’å…¥PostgreSQL').all();\nconst timestamp = new Date().toISOString().slice(0,10).replace(/-/g,'');\n\n// å°†æ’å…¥çš„æ•°æ®è½¬æ¢ä¸ºexport_from_db.pyæ ¼å¼çš„JSON\nconst bugs = insertedItems.map(item => ({\n  bug_id: item.json.bug_id,\n  bug_no_for_ui: item.json.bug_no_for_ui,\n  project_name: item.json.project_name || 'æœªçŸ¥é¡¹ç›®',\n  category_name: item.json.category_name || 'æœªåˆ†ç±»',\n  summary: item.json.summary || '',\n  detail_description: item.json.detail_description || '',\n  status_name: item.json.status_name,\n  priority_name: item.json.priority_name,\n  severity_name: item.json.severity_name,\n  bug_classification: item.json.bug_classification,\n  cause_large: item.json.cause_large,\n  cause_small: item.json.cause_small,\n  root_cause_text: item.json.root_cause_text,\n  fix_detail_text: item.json.fix_detail_text,\n  handler_display: item.json.handler_display,\n  fixer: item.json.fixer,\n  investigator: item.json.investigator,\n  registered_at: item.json.registered_at,\n  last_updated_at: item.json.last_updated_at,\n  reproducibility: item.json.reproducibility || 0\n}));\n\nconsole.log(`å‡†å¤‡å¤„ç†${bugs.length}æ¡æ–°æ•°æ®ç”ŸæˆçŸ¥è¯†åº“æ–‡æ¡£`);\n\nreturn [{\n  json: {\n    timestamp: timestamp,\n    bug_count: bugs.length,\n    bug_analysis: bugs,\n    should_process_knowledge: bugs.length > 0\n  }\n}];"
      },
      "id": "32562d90-ac23-41bc-8269-ce323f371041",
      "name": "å‡†å¤‡çŸ¥è¯†åº“æ•°æ®",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -672,
        160
      ],
      "onError": "continueErrorOutput",
      "notes": "å°†æ–°æ’å…¥çš„æ•°æ®è½¬æ¢ä¸ºçŸ¥è¯†åº“å¤„ç†æ‰€éœ€çš„JSONæ ¼å¼"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.should_process_knowledge }}",
              "value2": true
            }
          ]
        }
      },
      "id": "b0f3fd9d-d092-4cc8-8cbd-976616c6fb1c",
      "name": "åˆ¤æ–­æ˜¯å¦éœ€è¦å¤„ç†çŸ¥è¯†åº“",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -448,
        160
      ],
      "notes": "åªæœ‰å½“æœ‰æ–°æ•°æ®æ—¶æ‰å¤„ç†çŸ¥è¯†åº“"
    },
    {
      "parameters": {
        "jsCode": "// å‡†å¤‡æ–‡ä»¶è·¯å¾„å’ŒJSONæ•°æ®\nconst timestamp = $json.timestamp;\nconst inputFile = `/tmp/n8n_bug_export_${timestamp}.json`;\nconst outputFile = `/tmp/processed_bugs_${timestamp}.json`;\nconst mdOutputDir = `/home/node/.n8n/knowledge_base/batch_${timestamp}`;\n\n// å°†JSONæ•°æ®è½¬æ¢ä¸ºäºŒè¿›åˆ¶æ•°æ®ä¾›Write Binary FileèŠ‚ç‚¹ä½¿ç”¨\nconst data = { bug_analysis: $json.bug_analysis };\nconst jsonString = JSON.stringify(data, null, 2);\n\nreturn [{\n  json: {\n    timestamp: timestamp,\n    bug_count: $json.bug_count,\n    bug_analysis: $json.bug_analysis,  // ä¼ é€’bug_analysisåˆ°åç»­èŠ‚ç‚¹\n    input_file: inputFile,\n    output_file: outputFile,\n    md_output_dir: mdOutputDir\n  },\n  binary: {\n    data: {\n      data: Buffer.from(jsonString, 'utf-8').toString('base64'),\n      mimeType: 'application/json',\n      fileName: `bugs_export_${timestamp}.json`\n    }\n  }\n}];"
      },
      "id": "73be3053-5535-46e9-83ab-efc3f59a09eb",
      "name": "å‡†å¤‡æ–‡ä»¶æ•°æ®",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -224,
        80
      ],
      "onError": "continueErrorOutput",
      "notes": "å‡†å¤‡JSONæ•°æ®ç”¨äºå†™å…¥æ–‡ä»¶"
    },
    {
      "parameters": {
        "fileName": "={{ $json.input_file }}",
        "options": {}
      },
      "id": "ca98e99f-5b6b-40fd-9c9e-f851177aa6dd",
      "name": "å†™å…¥JSONæ–‡ä»¶",
      "type": "n8n-nodes-base.writeBinaryFile",
      "typeVersion": 1,
      "position": [
        0,
        0
      ],
      "onError": "continueErrorOutput",
      "notes": "å°†JSONæ•°æ®å†™å…¥ä¸´æ—¶æ–‡ä»¶"
    },
    {
      "parameters": {
        "jsCode": "// å†…è”å®ç°process_bugs_for_vectorization.pyçš„åŠŸèƒ½\n// ä¸ºæ¯ä¸ªbugç”Ÿæˆsummary/detail/solutionä¸‰ç§æ–‡æ¡£\n\n// ä»ä¸Šä¸€ä¸ªèŠ‚ç‚¹è·å–æ•°æ®\nconst inputData = $input.first().json;\nconst bugs = inputData.bug_analysis || [];\nconst timestamp = inputData.timestamp;\n\nif (!bugs || bugs.length === 0) {\n  console.log('è­¦å‘Š: æ²¡æœ‰bugæ•°æ®éœ€è¦å¤„ç†');\n  return [{\n    json: {\n      timestamp: timestamp,\n      documents: [],\n      stats: {\n        total: 0,\n        processed: 0,\n        summary_docs: 0,\n        detail_docs: 0,\n        solution_docs: 0,\n        total_docs: 0\n      },\n      md_output_dir: `/home/node/.n8n/knowledge_base/batch_${timestamp}`\n    }\n  }];\n}\n\nconst documents = [];\n\nlet stats = {\n  total: bugs.length,\n  processed: 0,\n  summary_docs: 0,\n  detail_docs: 0,\n  solution_docs: 0\n};\n\n// æ¸…æ´—æ–‡æœ¬å‡½æ•°\nfunction cleanText(text) {\n  if (!text || text.trim() === '') return '';\n  text = text.replace(/\\\\r\\\\n/g, '\\n').replace(/\\\\n/g, '\\n').replace(/\\r\\n/g, '\\n');\n  text = text.replace(/\\n\\s*\\n/g, '\\n\\n');\n  text = text.replace(/ +/g, ' ');\n  return text.trim();\n}\n\n// æå–å…³é”®è¯\nfunction extractKeywords(text, maxKeywords = 5) {\n  const patterns = [\n    /ResultSet|SQLException|NullPointerException|Exception/gi,\n    /COBOL|Java|RPG|CL|CLP|DSPF/gi,\n    /batch|ãƒãƒƒãƒ|ç”»é¢|UI|SubFile/gi,\n    /SELECT|INSERT|UPDATE|DELETE|TABLE/gi,\n    /\\w+Service|\\w+Dao|\\w+Controller/gi\n  ];\n  \n  const keywords = new Set();\n  patterns.forEach(pattern => {\n    const matches = text.match(pattern) || [];\n    matches.forEach(m => keywords.add(m));\n  });\n  \n  return Array.from(keywords).slice(0, maxKeywords);\n}\n\n// å¤„ç†æ¯ä¸ªbug\nbugs.forEach(bug => {\n  const bug_no = bug.bug_no_for_ui || 'UNKNOWN';\n  const summary = cleanText(bug.summary || '');\n  \n  // è·³è¿‡æ— æ•ˆæ•°æ®\n  if (!summary || summary.length < 10) return;\n  if (!['ç¢ºèªæ¸ˆ', 'closed', 'resolved'].includes(bug.status_name)) return;\n  \n  stats.processed++;\n  \n  // 1. ç”ŸæˆSummaryæ–‡æ¡£\n  const keywords = extractKeywords(summary);\n  const summaryContent = `# éšœå®³ ${bug_no}\\n\\n**é¡¹ç›®**: ${bug.project_name || 'æœªçŸ¥é¡¹ç›®'}  \\n**åˆ†ç±»**: ${bug.category_name || 'æœªåˆ†ç±»'}  \\n**çŠ¶æ€**: ${bug.status_name || 'æœªçŸ¥'}  \\n**ä¼˜å…ˆçº§**: ${bug.priority_name || 'normal'}  \\n**ä¸¥é‡ç¨‹åº¦**: ${bug.severity_name || 'trivial'}\\n\\n## é—®é¢˜æ‘˜è¦\\n${summary}\\n\\n**å…³é”®è¯**: ${keywords.join(', ') || 'æ— '}\\n`;\n  \n  documents.push({\n    doc_id: `bug_${bug_no}_summary`,\n    title: `éšœå®³${bug_no}-æ¦‚è¦`,\n    content: summaryContent,\n    metadata: {\n      doc_type: 'summary',\n      bug_id: bug.bug_id,\n      bug_no: bug_no,\n      project: bug.project_name,\n      category: bug.category_name\n    }\n  });\n  stats.summary_docs++;\n  \n  // 2. ç”ŸæˆDetailæ–‡æ¡£(å¦‚æœæœ‰è¯¦ç»†æè¿°)\n  const detail = cleanText(bug.detail_description || '');\n  if (detail && detail.length >= 20) {\n    const detailContent = `# éšœå®³è¯¦æƒ… ${bug_no}\\n\\n## é—®é¢˜æè¿°\\n${detail.substring(0, 1000)}${detail.length > 1000 ? '...' : ''}\\n\\n## éšœå®³åˆ†ç±»\\n- éšœå®³åŒºåˆ†: ${bug.bug_classification || 'æœªåˆ†ç±»'}\\n- åŸå› å¤§åˆ†ç±»: ${bug.cause_large || 'æœªçŸ¥'}\\n- åŸå› å°åˆ†ç±»: ${bug.cause_small || 'æœªçŸ¥'}\\n\\n## é‡ç°æ€§\\nå¤ç°ç‡: ${(bug.reproducibility || 0) * 10}%\\n`;\n    \n    documents.push({\n      doc_id: `bug_${bug_no}_detail`,\n      title: `éšœå®³${bug_no}-è¯¦æƒ…`,\n      content: detailContent,\n      metadata: {\n        doc_type: 'detail',\n        bug_id: bug.bug_id,\n        bug_no: bug_no\n      }\n    });\n    stats.detail_docs++;\n  }\n  \n  // 3. ç”ŸæˆSolutionæ–‡æ¡£(å¦‚æœæœ‰è§£å†³æ–¹æ¡ˆ)\n  const rootCause = cleanText(bug.root_cause_text || '');\n  const fixDetail = cleanText(bug.fix_detail_text || '');\n  \n  if ((rootCause && rootCause.length >= 20) || (fixDetail && fixDetail.length >= 20)) {\n    let solutionContent = `# éšœå®³è§£å†³æ–¹æ¡ˆ ${bug_no}\\n`;\n    \n    if (rootCause) {\n      solutionContent += `\\n## æ ¹æœ¬åŸå› \\n${rootCause}\\n`;\n    }\n    \n    if (fixDetail) {\n      solutionContent += `\\n## ä¿®æ­£å†…å®¹\\n${fixDetail}\\n`;\n    }\n    \n    solutionContent += `\\n## å¤„ç†ä¿¡æ¯\\n- è°ƒæŸ¥äºº: ${bug.investigator || 'æœªçŸ¥'}\\n- ä¿®æ­£äºº: ${bug.fixer || bug.handler_display || 'æœªçŸ¥'}\\n`;\n    \n    documents.push({\n      doc_id: `bug_${bug_no}_solution`,\n      title: `éšœå®³${bug_no}-æ–¹æ¡ˆ`,\n      content: solutionContent,\n      metadata: {\n        doc_type: 'solution',\n        bug_id: bug.bug_id,\n        bug_no: bug_no\n      }\n    });\n    stats.solution_docs++;\n  }\n});\n\nstats.total_docs = documents.length;\n\nconsole.log('ğŸ“Š å¤„ç†ç»Ÿè®¡:');\nconsole.log(`æ€»éšœå®³æ•°: ${stats.total}`);\nconsole.log(`å·²å¤„ç†: ${stats.processed}`);\nconsole.log(`æ¦‚è¦æ–‡æ¡£: ${stats.summary_docs}`);\nconsole.log(`è¯¦æƒ…æ–‡æ¡£: ${stats.detail_docs}`);\nconsole.log(`æ–¹æ¡ˆæ–‡æ¡£: ${stats.solution_docs}`);\nconsole.log(`æ€»æ–‡æ¡£æ•°: ${stats.total_docs}`);\n\nreturn [{\n  json: {\n    timestamp: timestamp,\n    documents: documents,\n    stats: stats,\n    md_output_dir: `/tmp/n8n_md_knowledge_base/batch_${timestamp}`\n  }\n}];"
      },
      "id": "3af092bd-e1fa-4b23-ac16-47c3d73c52a6",
      "name": "æ‰§è¡Œ-å¤„ç†å‘é‡åŒ–",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        224,
        80
      ],
      "onError": "continueErrorOutput",
      "notes": "å†…è”å®ç°å‘é‡åŒ–å¤„ç†,ç”Ÿæˆsummary/detail/solutionæ–‡æ¡£"
    },
    {
      "parameters": {
        "jsCode": "// å‡†å¤‡æ‰¹æ¬¡ç›®å½•ç»“æ„\nconst documents = $json.documents;\nconst timestamp = $json.timestamp;\nconst mdOutputDir = $json.md_output_dir;\nconst batchSize = 1000;\n\nconst totalBatches = Math.ceil(documents.length / batchSize);\nconst batchDirs = [];\n\nfor (let i = 0; i < totalBatches; i++) {\n  batchDirs.push(`${mdOutputDir}/batch_${String(i + 1).padStart(3, '0')}`);\n}\n\nconst mkdirCmd = `mkdir -p \"${mdOutputDir}\" \"${batchDirs.join('\" \"')}\"`;\n\nconsole.log(`å°†åˆ›å»º${totalBatches}ä¸ªæ‰¹æ¬¡ç›®å½•`);\n\nreturn [{\n  json: {\n    timestamp: timestamp,\n    documents: documents,\n    total_docs: documents.length,\n    batches: totalBatches,\n    output_dir: mdOutputDir,\n    batch_size: batchSize,\n    stats: $json.stats,\n    mkdir_cmd: mkdirCmd\n  }\n}];"
      },
      "id": "445dc4e9-8f22-4992-8299-68502a2acaec",
      "name": "å‡†å¤‡æ‰¹æ¬¡ç›®å½•",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        448,
        80
      ],
      "onError": "continueErrorOutput",
      "notes": "å‡†å¤‡Markdownæ‰¹æ¬¡ç›®å½•ç»“æ„"
    },
    {
      "parameters": {
        "command": "={{ $json.mkdir_cmd }}"
      },
      "id": "c855961f-c1fc-4b12-abab-7c2c138f817a",
      "name": "åˆ›å»ºç›®å½•ç»“æ„",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        672,
        80
      ],
      "onError": "continueErrorOutput",
      "notes": "åˆ›å»ºæ‰€æœ‰æ‰¹æ¬¡ç›®å½•"
    },
    {
      "parameters": {
        "jsCode": "// å±•å¼€documentsä¸ºå•ä¸ªitem,å‡†å¤‡é€ä¸ªå†™å…¥\n// ä»å‡†å¤‡æ‰¹æ¬¡ç›®å½•èŠ‚ç‚¹è·å–å®Œæ•´æ•°æ®\nconst prepareResult = $('å‡†å¤‡æ‰¹æ¬¡ç›®å½•').first().json;\nconst documents = prepareResult.documents;\nconst mdOutputDir = prepareResult.output_dir;\nconst batchSize = prepareResult.batch_size;\nconst timestamp = prepareResult.timestamp;\n\nif (!documents || documents.length === 0) {\n  console.log('è­¦å‘Š: æ²¡æœ‰æ–‡æ¡£éœ€è¦å†™å…¥');\n  return [];\n}\n\nconst result = documents.map((doc, index) => {\n  const batchIdx = Math.floor(index / batchSize) + 1;\n  const batchDir = `${mdOutputDir}/batch_${String(batchIdx).padStart(3, '0')}`;\n  const filename = `${doc.doc_id}.md`;\n  const filepath = `${batchDir}/${filename}`;\n  \n  // æ·»åŠ frontmatter\n  const frontmatter = `---\\ntitle: ${doc.title}\\ndoc_id: ${doc.doc_id}\\n---\\n\\n`;\n  const content = frontmatter + doc.content;\n  \n  return {\n    json: {\n      doc_id: doc.doc_id,\n      filepath: filepath,\n      batch_idx: batchIdx\n    },\n    binary: {\n      data: {\n        data: Buffer.from(content, 'utf-8').toString('base64'),\n        mimeType: 'text/markdown',\n        fileName: filename\n      }\n    }\n  };\n});\n\nconsole.log(`å‡†å¤‡å†™å…¥${result.length}ä¸ªMarkdownæ–‡ä»¶`);\n\nreturn result;"
      },
      "id": "3b10e2ff-025a-4a0a-bad6-5874d504b5eb",
      "name": "å±•å¼€æ–‡æ¡£åˆ—è¡¨",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        896,
        80
      ],
      "onError": "continueErrorOutput",
      "notes": "å°†documentsæ•°ç»„å±•å¼€ä¸ºå•ä¸ªitem"
    },
    {
      "parameters": {
        "fileName": "={{ $json.filepath }}",
        "options": {}
      },
      "id": "4790d007-6558-44ff-b0da-df80d76f3ab0",
      "name": "å†™å…¥Markdownæ–‡ä»¶",
      "type": "n8n-nodes-base.writeBinaryFile",
      "typeVersion": 1,
      "position": [
        1120,
        80
      ],
      "onError": "continueErrorOutput",
      "notes": "å†™å…¥æ–‡ä»¶åˆ°ç£ç›˜ï¼ŒåŒæ—¶ä¿ç•™binaryæ•°æ®ç”¨äºä¸Šä¼ "
    },
    {
      "parameters": {
        "jsCode": "// å‡†å¤‡æ¯ä¸ªæ–‡ä»¶çš„ä¸Šä¼ æ•°æ®(ä¿ç•™binary)\n// å¤„ç†æ‰€æœ‰itemsï¼Œè€Œä¸æ˜¯åªå¤„ç†ç¬¬ä¸€ä¸ª\nconst items = $input.all();\n\n// Difyé…ç½®\nconst difyConfig = {\n  api_base_url: 'http://192.168.8.247/v1',\n  dataset_id: 'e6750091-4fee-4064-b1ac-21de54264c34',\n  api_key: 'dataset-TrJ6xgZ1sNKif58fXBnjWJbm'\n};\n\nconst apiUrl = `${difyConfig.api_base_url}/datasets/${difyConfig.dataset_id}/document/create_by_file`;\n\nconsole.log(`å‡†å¤‡ä¸Šä¼ ${items.length}ä¸ªæ–‡ä»¶åˆ°DifyçŸ¥è¯†åº“`);\n\n// ä¸ºæ¯ä¸ªitemå‡†å¤‡ä¸Šä¼ å‚æ•°\nconst results = items.map(item => {\n  const docId = item.json.doc_id;\n  const filepath = item.json.filepath;\n  const filename = filepath.split('/').pop();\n  \n  return {\n    json: {\n      doc_id: docId,\n      filepath: filepath,\n      filename: filename,\n      api_url: apiUrl,\n      api_key: difyConfig.api_key,\n      indexing_technique: 'high_quality',\n      process_mode: 'automatic'\n    },\n    binary: item.binary  // ä¿ç•™æ¯ä¸ªitemçš„binaryæ•°æ®\n  };\n});\n\nconsole.log(`å·²å‡†å¤‡${results.length}ä¸ªæ–‡ä»¶å¾…ä¸Šä¼ `);\n\nreturn results;"
      },
      "id": "bb86519e-9a45-4032-acc9-fcfecb731601",
      "name": "å‡†å¤‡Difyä¸Šä¼ å‚æ•°",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1344,
        80
      ],
      "onError": "continueErrorOutput",
      "notes": "ä¸ºæ‰€æœ‰Markdownæ–‡ä»¶å‡†å¤‡ä¸Šä¼ å‚æ•°å¹¶ä¿ç•™binaryæ•°æ®"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.api_url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.api_key }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "file",
              "inputDataFieldName": "=data"
            },
            {
              "name": "data",
              "value": "={\"indexing_technique\":\"high_quality\",\"process_rule\":{\"mode\":\"automatic\"}}"
            }
          ]
        },
        "options": {
          "timeout": 60000
        }
      },
      "id": "f58ef37e-7b34-4370-9fb6-252127f110a1",
      "name": "ä¸Šä¼ åˆ°DifyçŸ¥è¯†åº“",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1568,
        80
      ],
      "onError": "continueErrorOutput",
      "notes": "ä½¿ç”¨formBinaryDataç±»å‹ä¸Šä¼ æ–‡ä»¶"
    },
    {
      "parameters": {
        "jsCode": "// ç»Ÿè®¡Difyä¸Šä¼ ç»“æœ\nconst uploadResults = $('ä¸Šä¼ åˆ°DifyçŸ¥è¯†åº“').all();\nconst prepareResult = $('å‡†å¤‡æ‰¹æ¬¡ç›®å½•').first().json;\n\nlet successCount = 0;\nlet failCount = 0;\nconst failedDocs = [];\n\nuploadResults.forEach((result) => {\n  const prepareItems = $('å‡†å¤‡Difyä¸Šä¼ å‚æ•°').all();\n  const index = uploadResults.indexOf(result);\n  const docId = prepareItems[index]?.json?.doc_id || `doc_${index}`;\n  const filename = prepareItems[index]?.json?.filename || 'unknown';\n  \n  // HTTP RequestæˆåŠŸè¿”å›2xxçŠ¶æ€ç \n  const statusCode = result.json.statusCode || result.json.code || 0;\n  \n  if (statusCode >= 200 && statusCode < 300) {\n    successCount++;\n    console.log(`âœ… æˆåŠŸ: ${filename}`);\n  } else {\n    failCount++;\n    failedDocs.push({\n      doc_id: docId,\n      filename: filename,\n      status: statusCode,\n      error: result.json.message || result.json.error || JSON.stringify(result.json)\n    });\n    console.error(`âŒ å¤±è´¥: ${filename}, status: ${statusCode}`);\n  }\n});\n\nconst message = `Difyä¸Šä¼ å®Œæˆ: æˆåŠŸ${successCount}ä¸ª, å¤±è´¥${failCount}ä¸ª`;\nconsole.log(message);\n\nif (failedDocs.length > 0) {\n  console.log('å¤±è´¥æ–‡æ¡£åˆ—è¡¨:', JSON.stringify(failedDocs, null, 2));\n}\n\nreturn [{\n  json: {\n    timestamp: prepareResult.timestamp,\n    dify_upload_completed: true,\n    total_docs: uploadResults.length,\n    success_count: successCount,\n    fail_count: failCount,\n    failed_docs: failedDocs,\n    message: message\n  }\n}];"
      },
      "id": "85787eaf-75be-4dc0-b476-841e0311f1ac",
      "name": "ç»Ÿè®¡Difyä¸Šä¼ ç»“æœ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1792,
        80
      ],
      "onError": "continueErrorOutput",
      "notes": "ç»Ÿè®¡HTTPä¸Šä¼ çš„æˆåŠŸå’Œå¤±è´¥æ•°é‡"
    },
    {
      "parameters": {
        "jsCode": "// å‡†å¤‡å¤åˆ¶æ–‡ä»¶åˆ°æŒä¹…åŒ–ç›®å½•çš„å‘½ä»¤\nconst prepareResult = $('å‡†å¤‡æ‰¹æ¬¡ç›®å½•').first().json;\nconst mdOutputDir = prepareResult.output_dir;\nconst persistentDir = '/home/node/.n8n/knowledge_base';\n\n// æ„å»ºå¤åˆ¶å‘½ä»¤\nconst copyCmd = `mkdir -p \"${persistentDir}\" && cp -r \"${mdOutputDir}\" \"${persistentDir}/\"`;\n\nconsole.log('å‡†å¤‡å¤åˆ¶æ–‡ä»¶åˆ°æŒä¹…åŒ–ç›®å½•:', persistentDir);\n\nreturn [{\n  json: {\n    copy_cmd: copyCmd,\n    source_dir: mdOutputDir,\n    target_dir: persistentDir,\n    timestamp: prepareResult.timestamp\n  }\n}];"
      },
      "id": "61c21a63-13c8-4a41-b85a-146314d4a36c",
      "name": "å‡†å¤‡å¤åˆ¶åˆ°æŒä¹…åŒ–ç›®å½•",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1280,
        -208
      ],
      "onError": "continueErrorOutput",
      "notes": "å‡†å¤‡å°†æ–‡ä»¶å¤åˆ¶åˆ°n8næŒä¹…åŒ–æ•°æ®ç›®å½•"
    },
    {
      "parameters": {
        "command": "={{ $json.copy_cmd }}"
      },
      "id": "d09ca906-3f7c-423f-aa24-fbf5eedafd7f",
      "name": "å¤åˆ¶åˆ°æŒä¹…åŒ–ç›®å½•",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        1616,
        -208
      ],
      "onError": "continueErrorOutput",
      "notes": "æ‰§è¡Œå¤åˆ¶å‘½ä»¤,å°†æ–‡ä»¶å¤åˆ¶åˆ°æŒä¹…åŒ–ç›®å½•"
    },
    {
      "parameters": {
        "command": "=rm -f {{ $('å‡†å¤‡æ–‡ä»¶æ•°æ®').first().json.input_file }} {{ $('å‡†å¤‡æ–‡ä»¶æ•°æ®').first().json.output_file }}"
      },
      "id": "63c7e76a-ab21-42a8-96a4-79e5fccbe038",
      "name": "æ¸…ç†ä¸´æ—¶æ–‡ä»¶",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        560,
        -272
      ],
      "onError": "continueErrorOutput",
      "notes": "åˆ é™¤ä¸´æ—¶JSONæ–‡ä»¶"
    },
    {
      "parameters": {
        "jsCode": "// ç»Ÿè®¡å†™å…¥ç»“æœå’ŒDifyä¸Šä¼ ç»“æœ\nconst mdGenResult = $('å‡†å¤‡æ‰¹æ¬¡ç›®å½•').first().json;\nconst writtenFiles = $('å†™å…¥Markdownæ–‡ä»¶').all();\nconst difyResult = $('ç»Ÿè®¡Difyä¸Šä¼ ç»“æœ').first().json;\n\nconst message = `çŸ¥è¯†åº“é¢„å¤„ç†å®Œæˆ: ç”Ÿæˆ${writtenFiles.length}ä¸ªMarkdownæ–‡ä»¶åˆ°${mdGenResult.batches}ä¸ªæ‰¹æ¬¡ç›®å½•\\nDifyä¸Šä¼ : æˆåŠŸ${difyResult.success_count}ä¸ª, å¤±è´¥${difyResult.fail_count}ä¸ª`;\nconsole.log(message);\n\nif (difyResult.failed_docs && difyResult.failed_docs.length > 0) {\n  console.log('Difyä¸Šä¼ å¤±è´¥æ–‡æ¡£:', JSON.stringify(difyResult.failed_docs, null, 2));\n}\n\nreturn [{\n  json: {\n    timestamp: mdGenResult.timestamp,\n    knowledge_processed: true,\n    stats: mdGenResult.stats,\n    output_dir: mdGenResult.output_dir,\n    total_docs: mdGenResult.total_docs,\n    md_files: writtenFiles.length,\n    batches: mdGenResult.batches,\n    dify_upload: {\n      total: difyResult.total_docs,\n      success: difyResult.success_count,\n      failed: difyResult.fail_count,\n      failed_docs: difyResult.failed_docs\n    },\n    message: message\n  }\n}];"
      },
      "id": "13b7bd06-7b45-4bd6-8f4b-d323bff023e3",
      "name": "è§£æçŸ¥è¯†åº“å¤„ç†ç»“æœ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        944,
        -256
      ],
      "onError": "continueErrorOutput",
      "notes": "è§£æMarkdownç”Ÿæˆå’ŒDifyä¸Šä¼ ç»“æœ"
    },
    {
      "parameters": {
        "jsCode": "// æ›´æ–°è¿›åº¦å¹¶åˆ¤æ–­æ˜¯å¦ç»§ç»­\nconst syncLogId = $('åˆ›å»ºåŒæ­¥æ—¥å¿—').first().json.sync_log_id;\nconst insertedItems = $('é€æ¡æ’å…¥PostgreSQL').all();\nconst processedCount = insertedItems.length;\n\n// ä»æŸ¥è¯¢ç»“æœè·å–offsetä¿¡æ¯\nconst sourceItems = $('æŸ¥è¯¢å¾…åŒæ­¥æ•°æ®').all();\nconst currentOffset = sourceItems.length > 0 ? sourceItems[0].json.current_offset : 0;\nconst sourceCount = sourceItems.length;  // æŸ¥è¯¢åˆ°çš„åŸå§‹æ•°æ®é‡\n\nconst maxSyncedBugId = $('å‡†å¤‡æŸ¥è¯¢å‚æ•°').first().json.max_synced_bug_id;\n\n// ğŸ”¥ å…³é”®ä¿®å¤: è®¡ç®—æœ¬æ¬¡å®é™…å¤„ç†çš„æœ€å¤§bug_id\nconst processedBugIds = insertedItems.map(item => item.json.bug_id || 0);\nconst currentMaxBugId = processedBugIds.length > 0 ? Math.max(...processedBugIds) : maxSyncedBugId;\n\n// è·å–çŸ¥è¯†åº“å¤„ç†ç»“æœ\nconst knowledgeResult = $('è§£æçŸ¥è¯†åº“å¤„ç†ç»“æœ').first();\nconst knowledgeStats = knowledgeResult ? knowledgeResult.json.stats : null;\n\nconsole.log(`æŸ¥è¯¢åˆ°${sourceCount}æ¡, è¿‡æ»¤åæ’å…¥${processedCount}æ¡, æœ€å¤§bug_id: ${currentMaxBugId}`);\nif (knowledgeStats) {\n  console.log(`çŸ¥è¯†åº“: ç”Ÿæˆ${knowledgeStats.total_docs}ä¸ªæ–‡æ¡£, ${knowledgeStats.md_files}ä¸ªMDæ–‡ä»¶`);\n}\n\n// åˆ¤æ–­æ˜¯å¦ç»§ç»­: åŸºäºæŸ¥è¯¢åˆ°çš„åŸå§‹æ•°æ®é‡,è€Œéæ’å…¥æ•°é‡\nconst shouldContinue = sourceCount >= 500;\n\nreturn [{\n  json: {\n    sync_log_id: syncLogId,\n    records_processed: processedCount,\n    next_offset: currentOffset + 500,\n    should_continue: shouldContinue,\n    max_synced_bug_id: maxSyncedBugId,\n    current_max_bug_id: currentMaxBugId,  // æœ¬æ¬¡å¤„ç†çš„æœ€å¤§bug_id\n    knowledge_stats: knowledgeStats\n  }\n}];"
      },
      "id": "4a6cfa39-35b0-4aa8-95c3-1a36c7fe4825",
      "name": "æ›´æ–°å¤„ç†è¿›åº¦",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        672,
        336
      ],
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "// æ²¡æœ‰æ–°æ•°æ®æ—¶ï¼Œå‡†å¤‡ç»§ç»­ä¸‹ä¸€æ‰¹çš„å‚æ•°\nconst syncLogId = $('åˆ›å»ºåŒæ­¥æ—¥å¿—').first().json.sync_log_id;\nconst sourceItems = $('æŸ¥è¯¢å¾…åŒæ­¥æ•°æ®').all();\nconst currentOffset = sourceItems.length > 0 ? sourceItems[0].json.current_offset : 0;\nconst sourceCount = sourceItems.length;\nconst maxSyncedBugId = $('å‡†å¤‡æŸ¥è¯¢å‚æ•°').first().json.max_synced_bug_id;\n\nconsole.log(`æœ¬æ‰¹${sourceCount}æ¡æ•°æ®å…¨éƒ¨å·²å­˜åœ¨ï¼Œè·³è¿‡æ’å…¥ï¼Œç»§ç»­ä¸‹ä¸€æ‰¹`);\n\n// åˆ¤æ–­æ˜¯å¦ç»§ç»­\nconst shouldContinue = sourceCount >= 500;\n\nreturn [{\n  json: {\n    sync_log_id: syncLogId,\n    records_processed: 0,  // å®é™…æ’å…¥0æ¡\n    next_offset: currentOffset + 500,\n    should_continue: shouldContinue,\n    max_synced_bug_id: maxSyncedBugId,\n    current_max_bug_id: maxSyncedBugId,  // æ²¡æœ‰æ–°æ•°æ®ï¼Œä¿æŒåŸå€¼\n    skipped: true\n  }\n}];"
      },
      "id": "0e868d67-0c08-4f7a-811c-dd6e07215176",
      "name": "å‡†å¤‡è·³è¿‡è¿›åº¦",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1040,
        592
      ],
      "onError": "continueErrorOutput",
      "notes": "å½“æœ¬æ‰¹æ•°æ®å…¨éƒ¨å·²å­˜åœ¨æ—¶ï¼Œè·³è¿‡æ’å…¥ä½†ç»§ç»­åˆ¤æ–­ä¸‹ä¸€æ‰¹"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.should_continue }}",
              "value2": true
            }
          ]
        }
      },
      "id": "a9fe0e2c-a020-45b5-91a2-d38fcc5c093c",
      "name": "åˆ¤æ–­æ˜¯å¦ç»§ç»­",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -544,
        512
      ]
    },
    {
      "parameters": {
        "jsCode": "// å‡†å¤‡ä¸‹ä¸€æ‰¹æ¬¡å‚æ•°\nreturn [{\n  json: {\n    offset: $json.next_offset,\n    max_synced_bug_id: $json.max_synced_bug_id,\n    sync_log_id: $json.sync_log_id\n  }\n}];"
      },
      "id": "71e53ea1-74ab-4390-8d85-0b34f2af8bf7",
      "name": "å‡†å¤‡ä¸‹ä¸€æ‰¹",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -320,
        608
      ],
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE mantis.sync_log \nSET \n  sync_status = 'SUCCESS',\n  end_time = NOW(),\n  execution_time_seconds = EXTRACT(EPOCH FROM (NOW() - start_time))::INTEGER,\n  last_synced_timestamp = NOW(),\n  last_synced_bug_id = (SELECT MAX(bug_id) FROM mantis.bug_analysis)\nWHERE id = {{ $('åˆ›å»ºåŒæ­¥æ—¥å¿—').first().json.sync_log_id }};",
        "options": {}
      },
      "id": "db121f90-7cbe-4e0e-9be4-d665a99b92b1",
      "name": "å®ŒæˆåŒæ­¥æ—¥å¿—",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.1,
      "position": [
        -1568,
        864
      ],
      "credentials": {
        "postgres": {
          "id": "tWcUIJhVg6bDlGDc",
          "name": "TargetDB"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE mantis.sync_config \nSET config_value = NOW()::TEXT\nWHERE config_key = 'last_sync_timestamp';",
        "options": {}
      },
      "id": "ebb009f1-0240-4667-bd7a-f1c78f6d9551",
      "name": "æ›´æ–°åŒæ­¥é…ç½®",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.1,
      "position": [
        -1296,
        848
      ],
      "credentials": {
        "postgres": {
          "id": "tWcUIJhVg6bDlGDc",
          "name": "TargetDB"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  COUNT(*) as total_records,\n  MAX(last_updated_at) as latest_update,\n  MIN(registered_at) as earliest_create\nFROM mantis.bug_analysis;",
        "options": {}
      },
      "id": "a9500c7b-d1fc-40d1-ab0d-d5277ba8aa86",
      "name": "è·å–æœ€ç»ˆç»Ÿè®¡",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.1,
      "position": [
        -1040,
        832
      ],
      "credentials": {
        "postgres": {
          "id": "tWcUIJhVg6bDlGDc",
          "name": "TargetDB"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 2
            }
          ]
        }
      },
      "id": "ec7779d1-1c6d-4cad-a470-d6679cb1cedd",
      "name": "å®šæ—¶è§¦å‘_æ¯2h",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -2800,
        672
      ],
      "notes": "æ¯2hè‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡ï¼Œå¿«é€ŸåŒæ­¥å­˜é‡æ•°æ®"
    }
  ],
  "pinData": {},
  "connections": {
    "æŸ¥è¯¢å·²åŒæ­¥çš„æœ€å¤§BugID": {
      "main": [
        [
          {
            "node": "åˆ›å»ºåŒæ­¥æ—¥å¿—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åˆ›å»ºåŒæ­¥æ—¥å¿—": {
      "main": [
        [
          {
            "node": "å‡†å¤‡æŸ¥è¯¢å‚æ•°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å‡†å¤‡æŸ¥è¯¢å‚æ•°": {
      "main": [
        [
          {
            "node": "æŸ¥è¯¢å¾…åŒæ­¥æ•°æ®",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æŸ¥è¯¢å¾…åŒæ­¥æ•°æ®": {
      "main": [
        [
          {
            "node": "åˆ¤æ–­æ˜¯å¦æœ‰æ•°æ®",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åˆ¤æ–­æ˜¯å¦æœ‰æ•°æ®": {
      "main": [
        [
          {
            "node": "æŸ¥è¯¢å·²å­˜åœ¨çš„BugIDåˆ—è¡¨",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "å®ŒæˆåŒæ­¥æ—¥å¿—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æŸ¥è¯¢å·²å­˜åœ¨çš„BugIDåˆ—è¡¨": {
      "main": [
        [
          {
            "node": "è¿‡æ»¤æ–°æ•°æ®",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è¿‡æ»¤æ–°æ•°æ®": {
      "main": [
        [
          {
            "node": "åˆ¤æ–­æ˜¯å¦æœ‰æ–°æ•°æ®è¦æ’å…¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åˆ¤æ–­æ˜¯å¦æœ‰æ–°æ•°æ®è¦æ’å…¥": {
      "main": [
        [
          {
            "node": "é€æ¡æ’å…¥PostgreSQL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "å‡†å¤‡è·³è¿‡è¿›åº¦",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "é€æ¡æ’å…¥PostgreSQL": {
      "main": [
        [
          {
            "node": "å‡†å¤‡çŸ¥è¯†åº“æ•°æ®",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å‡†å¤‡çŸ¥è¯†åº“æ•°æ®": {
      "main": [
        [
          {
            "node": "åˆ¤æ–­æ˜¯å¦éœ€è¦å¤„ç†çŸ¥è¯†åº“",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åˆ¤æ–­æ˜¯å¦éœ€è¦å¤„ç†çŸ¥è¯†åº“": {
      "main": [
        [
          {
            "node": "å‡†å¤‡æ–‡ä»¶æ•°æ®",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "æ›´æ–°å¤„ç†è¿›åº¦",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å‡†å¤‡æ–‡ä»¶æ•°æ®": {
      "main": [
        [
          {
            "node": "å†™å…¥JSONæ–‡ä»¶",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å†™å…¥JSONæ–‡ä»¶": {
      "main": [
        [
          {
            "node": "æ‰§è¡Œ-å¤„ç†å‘é‡åŒ–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ‰§è¡Œ-å¤„ç†å‘é‡åŒ–": {
      "main": [
        [
          {
            "node": "å‡†å¤‡æ‰¹æ¬¡ç›®å½•",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å‡†å¤‡æ‰¹æ¬¡ç›®å½•": {
      "main": [
        [
          {
            "node": "åˆ›å»ºç›®å½•ç»“æ„",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åˆ›å»ºç›®å½•ç»“æ„": {
      "main": [
        [
          {
            "node": "å±•å¼€æ–‡æ¡£åˆ—è¡¨",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å±•å¼€æ–‡æ¡£åˆ—è¡¨": {
      "main": [
        [
          {
            "node": "å†™å…¥Markdownæ–‡ä»¶",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å†™å…¥Markdownæ–‡ä»¶": {
      "main": [
        [
          {
            "node": "å‡†å¤‡Difyä¸Šä¼ å‚æ•°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å‡†å¤‡Difyä¸Šä¼ å‚æ•°": {
      "main": [
        [
          {
            "node": "ä¸Šä¼ åˆ°DifyçŸ¥è¯†åº“",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ä¸Šä¼ åˆ°DifyçŸ¥è¯†åº“": {
      "main": [
        [
          {
            "node": "ç»Ÿè®¡Difyä¸Šä¼ ç»“æœ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ç»Ÿè®¡Difyä¸Šä¼ ç»“æœ": {
      "main": [
        [
          {
            "node": "å‡†å¤‡å¤åˆ¶åˆ°æŒä¹…åŒ–ç›®å½•",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å‡†å¤‡å¤åˆ¶åˆ°æŒä¹…åŒ–ç›®å½•": {
      "main": [
        [
          {
            "node": "å¤åˆ¶åˆ°æŒä¹…åŒ–ç›®å½•",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å¤åˆ¶åˆ°æŒä¹…åŒ–ç›®å½•": {
      "main": [
        [
          {
            "node": "æ¸…ç†ä¸´æ—¶æ–‡ä»¶",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ¸…ç†ä¸´æ—¶æ–‡ä»¶": {
      "main": [
        [
          {
            "node": "è§£æçŸ¥è¯†åº“å¤„ç†ç»“æœ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è§£æçŸ¥è¯†åº“å¤„ç†ç»“æœ": {
      "main": [
        [
          {
            "node": "æ›´æ–°å¤„ç†è¿›åº¦",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ›´æ–°å¤„ç†è¿›åº¦": {
      "main": [
        [
          {
            "node": "åˆ¤æ–­æ˜¯å¦ç»§ç»­",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å‡†å¤‡è·³è¿‡è¿›åº¦": {
      "main": [
        [
          {
            "node": "åˆ¤æ–­æ˜¯å¦ç»§ç»­",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åˆ¤æ–­æ˜¯å¦ç»§ç»­": {
      "main": [
        [
          {
            "node": "å‡†å¤‡ä¸‹ä¸€æ‰¹",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "å®ŒæˆåŒæ­¥æ—¥å¿—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å‡†å¤‡ä¸‹ä¸€æ‰¹": {
      "main": [
        [
          {
            "node": "æŸ¥è¯¢å¾…åŒæ­¥æ•°æ®",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å®ŒæˆåŒæ­¥æ—¥å¿—": {
      "main": [
        [
          {
            "node": "æ›´æ–°åŒæ­¥é…ç½®",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ›´æ–°åŒæ­¥é…ç½®": {
      "main": [
        [
          {
            "node": "è·å–æœ€ç»ˆç»Ÿè®¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å®šæ—¶è§¦å‘_æ¯2h": {
      "main": [
        [
          {
            "node": "æŸ¥è¯¢å·²åŒæ­¥çš„æœ€å¤§BugID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "1360c798-4636-411c-a70c-e8dc019875a7",
  "meta": {
    "instanceId": "1003d7a4418464b97d5dcd6234164bb132b89fde605b38f31cba0abf5a7b1b81"
  },
  "id": "LjKotXLeLBLTEGDM",
  "tags": [
    {
      "createdAt": "2025-10-10T08:32:49.722Z",
      "updatedAt": "2025-10-10T08:32:49.722Z",
      "id": "LzKc1zENSTrzLIN6",
      "name": "MantisåŒæ­¥"
    }
  ]
}